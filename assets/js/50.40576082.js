(window.webpackJsonp=window.webpackJsonp||[]).push([[50],{338:function(t,a,n){"use strict";n.r(a);var e=n(11),s=Object(e.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"认证"}},[t._v("认证")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("认证（Authentication）")]),t._v(" "),n("p",[t._v("系统如何正确分辨出操作用户的真实身份？")])]),t._v(" "),n("p",[t._v("“认证”可以说是一个系统中最基础的安全设计，再简陋的系统大概也不大可能省略掉“用户登录”功能。但“认证”这件事情又并不如大多数人所认为的那样，校验一下 用户名、密码是否正确这么简单。尤其是在基于Java的软件系统里，尝试去触接了解Java安全标准的人往往会对一些今天看起来很别扭的概念产生疑惑。在这一部分，将简要概览一下关于认证的主流行业规范、标准；项目中具体如何认证、授权的内容放到下一节去介绍。")]),t._v(" "),n("p",[t._v("最初的Java系统里，安全中的“认证”其实是特指“代码级安全”（你是否信任要在你的电脑中运行的代码），这是由“Java 2”之前它的主要应用形式Applets所决定的：从远端下载一段Java代码，以Applet的形式在用户的浏览器中运行，当然要保证这些代码不会损害用户的计算机才行。这一阶段的安全催生了今天仍然存在于Java体系中的“安全管理器”（java.lang.SecurityManager）、“代码权限许可”（java.lang.RuntimePermission）这些概念。")]),t._v(" "),n("p",[t._v("不久之后，Java迎来了互联网的迅速兴起，进入了Java第一次快速发展时期，基于超文本的Web应用迅速盖过了“Java 2”时代之前的Applet，此时“安全认证”的重点逐渐转为“用户级安全”（你是否信任正在操作的用户）。在1999年随着J2EE 1.2（它是J2EE的首个版本，版本号直接就是1.2）所发布的Servlet 2.2中增加了一系列认证的API，诸如：")]),t._v(" "),n("ul",[n("li",[t._v("HttpServletRequest.isUserInRole()")]),t._v(" "),n("li",[t._v("HttpServletRequest.getUserPrincipal()")]),t._v(" "),n("li",[t._v("还内置支持了四种硬编码、不可扩展的认证机制：BASIC、FORM、CLIENT-CERT和DIGEST。")])]),t._v(" "),n("p",[t._v("到Java 1.3时代中，Sun公司提出了同时面向与代码级安全和用户级安全的认证授权服务JAAS（Java Authentication and Authorization Service，1.3处于扩展包中，1.4纳入标准包），不过相对而言，在JAAS中代码级安全仍然是占更主要的地位。")]),t._v(" "),n("p",[t._v("由于用户数据可能来自于各种不同的数据源（譬如RDBMS、JNDI、LDAP等等），JAAS设计了一种插入式（Pluggable）的认证和授权模型，以适配各种环境。在今天仍然活跃的主流安全框架中的许多概念，譬如用户叫做“Subject / Principal”、密码存在“Credentials”之中、登陆后从安全上下文“Context”中获取状态等都可以追溯到这一时期所设计的API：")]),t._v(" "),n("ul",[n("li",[t._v("LoginModule （javax.security.auth.spi.LoginModule）")]),t._v(" "),n("li",[t._v("LoginContext （javax.security.auth.login.LoginContext）")]),t._v(" "),n("li",[t._v("Subject （javax.security.auth.Subject）")]),t._v(" "),n("li",[t._v("Principal （java.security.Principal）")]),t._v(" "),n("li",[t._v("Credentials（javax.security.auth.Destroyable、javax.security.auth.Refreshable）")])]),t._v(" "),n("p",[t._v("但是，尽管JAAS开创了许多沿用至今的安全概念，实质上并没有得到广泛的应用。这里有两大原因，一方面是由于JAAS同时面向代码级和用户级的安全机制，使得它过度复杂化，难以推广。在这里问题上JCP一直在做着持续的增强和补救，譬如Java EE 6中的JASPIC、Java EE 8中的EE Security：")]),t._v(" "),n("ul",[n("li",[t._v("JSR 115："),n("a",{attrs:{href:"https://jcp.org/aboutJava/communityprocess/mrel/jsr115/index3.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Java Authorization Contract for Containers"),n("OutboundLink")],1),t._v("（JACC）")]),t._v(" "),n("li",[t._v("JSR 196："),n("a",{attrs:{href:"https://jcp.org/aboutJava/communityprocess/mrel/jsr196/index2.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Java Authentication Service Provider Interface for Containers"),n("OutboundLink")],1),t._v("（JASPIC）")]),t._v(" "),n("li",[t._v("JSR 375： "),n("a",{attrs:{href:"https://jcp.org/en/jsr/detail?id=375",target:"_blank",rel:"noopener noreferrer"}},[t._v("Java EE Security API"),n("OutboundLink")],1),t._v("（EE Security）")])]),t._v(" "),n("p",[t._v("而另一方面，可能是更重要的一个原因是在21世纪的第一个十年里，以EJB为代表的容器化J2EE与以“Without EJB”为口号、以Spring、Hibernate等为代表的轻量化企业级开发框架之争，以后者的胜利而结束。这也使得依赖于容器安全的JAAS无法得到大多数人的认可。")]),t._v(" "),n("p",[t._v("在今时今日，实际活跃于Java届的两大私有的（私有的意思是不由JSR所规范的，即没有java/javax.*作为包名的）的安全框架：")]),t._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://shiro.apache.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Apache Shiro"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://spring.io/projects/spring-security",target:"_blank",rel:"noopener noreferrer"}},[t._v("Spring Security"),n("OutboundLink")],1)])]),t._v(" "),n("p",[t._v("相较而言，Shiro使用更为便捷易用，而Spring Security的功能则要复杂强大一些。在我们的项目中（无论是单体架构还是微服务架构），均选择了Spring Security作为安全框架。当然，这里面也有很大一部分是因为Spring Boot/Cloud全家桶的原因。这两大安全框架都解决的问题都很类似，大致可以分为四类：")]),t._v(" "),n("ul",[n("li",[t._v("认证：以HTTP协议中定义的各种认证、表单等认证方式确认用户身份，这是本节的主要话题。")]),t._v(" "),n("li",[t._v("授权：主要是授权结果，即访问控制（Access Control），稍后讲的“授权”将聚焦在授权的过程，尤其是多方授权中。这部分内容会放到下一节一起讨论。")]),t._v(" "),n("li",[t._v("密码的存储：就是字面意思，我们会放到“保密”这节去一起讨论。")]),t._v(" "),n("li",[t._v("安全上下文：用户获得认证之后，需要有API可以得知该用户的基本资料、用户拥有的权限、角色等。")])]),t._v(" "),n("p",[t._v("介绍了一大段关于Java中安全标准的历史，我们最终还是要切入到如何处理认证的话题上，这可是随着网络出现就有的一个东西，所以，IETF的最初想法是基于Web的验证就应该在HTTP协议层面来解决。")]),t._v(" "),n("div",{staticClass:"quote"},[n("p",{staticClass:"title"},[t._v("互联网工程任务组（Internet Engineering Task Force，IETF）")]),n("p",[t._v('管理和发布互联网标准的组织，其标准以RFC即"请求意见稿"Request for Comments的形式发出。不仅是HTTP，几乎目前所有的主要网络协议，如IP、TCP、UDP、FTP、CMIP、SOCKS，等等都是以RFC形式定义的。')])]),n("p",[t._v("IETF给HTTP 1.1协议定义了401（Unauthorized，未授权）状态码，当服务端向客户端返回此状态码时，应在Header中附带一个WWW-Authenticate项，此项目通过跟随的一个可扩展的Scheme，告诉客户端应该采取怎样的方式来开始验证，例如：")]),t._v(" "),n("div",{staticClass:"language-http extra-class"},[n("pre",{pre:!0,attrs:{class:"language-http"}},[n("code",[n("span",{pre:!0,attrs:{class:"token response-status"}},[t._v("HTTP/1.1 "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v("401 Unauthorized")])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Date:")]),t._v(" Mon, 24 Feb 2020 16:50:53 GMT\n"),n("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("WWW-Authenticate:")]),t._v(' Basic realm="From icyfenix.cn"\n')])])]),n("p",[t._v("同时，IETF也定义了几种标准的Schema，对应了一些预定义好的认证方式，包括：")]),t._v(" "),n("ul",[n("li",[n("strong",[t._v("Basic")]),t._v("："),n("a",{attrs:{href:"https://tools.ietf.org/html/rfc7617",target:"_blank",rel:"noopener noreferrer"}},[t._v("RFC 7617"),n("OutboundLink")],1),t._v("，HTTP基础认证，弹出一个输入框，把用户名和密码Base64之后发送出去")]),t._v(" "),n("li",[n("strong",[t._v("Digest")]),t._v("："),n("a",{attrs:{href:"https://tools.ietf.org/html/rfc7616",target:"_blank",rel:"noopener noreferrer"}},[t._v("RFC 7616"),n("OutboundLink")],1),t._v("，HTTP摘要认证，弹出一个输入框，把用户名和密码加盐后再通过MD5/SHA等哈希算法摘要后发送出去")]),t._v(" "),n("li",[n("strong",[t._v("Bearer")]),t._v("："),n("a",{attrs:{href:"https://tools.ietf.org/html/rfc6750",target:"_blank",rel:"noopener noreferrer"}},[t._v("RFC 6750"),n("OutboundLink")],1),t._v("，OAuth 2.0令牌（OAuth2是一个授权协议，但同时也涉及到认证的内容，下一节的主角）")]),t._v(" "),n("li",[n("strong",[t._v("HOBA")]),t._v("："),n("a",{attrs:{href:"https://tools.ietf.org/html/rfc7486",target:"_blank",rel:"noopener noreferrer"}},[t._v("RFC 7486"),n("OutboundLink")],1),t._v(" ，"),n("strong",[t._v("H")]),t._v("TTP "),n("strong",[t._v("O")]),t._v("rigin-"),n("strong",[t._v("B")]),t._v("ound "),n("strong",[t._v("A")]),t._v("uthentication的缩写，一种基于数字签名的认证。")])]),t._v(" "),n("p",[t._v("因为Scheme是允许自定义扩展的，很多厂商也加入了自己的认证方式，譬如：")]),t._v(" "),n("ul",[n("li",[n("strong",[t._v("AWS4-HMAC-SHA256")]),t._v("：简单粗暴的名字，一看就是亚马逊AWS基于HMAC-SHA256哈希算法的认证")]),t._v(" "),n("li",[n("strong",[t._v("NTLM")]),t._v(" / "),n("strong",[t._v("Negotiate")]),t._v("：微软公司NT LAN Manager（NTLM）用到的两种认证方式")]),t._v(" "),n("li",[n("strong",[t._v("Windows Live ID")]),t._v("：这个不需要解释了")]),t._v(" "),n("li",[n("strong",[t._v("Twitter Basic")]),t._v("：一个不存在的网站所改良的HTTP基础认证")]),t._v(" "),n("li",[t._v("……")])]),t._v(" "),n("p",[t._v("现在主流的信息系统，直接采用上面这些认证方式比例不算太高，目前的主流仍是Form表单认证，即我们通常所说的“登陆页面”。表单认证并没有什么行业标准可循，表单中的用户字段、密码字段、验证码字段、是否要在客户端加密、加密的方式、接受表单的服务入口等都可由服务端、客户端自行协商决定。")]),t._v(" "),n("p",[t._v("在Fenix's Bookstore项目中，我们所设计的登录实质上也是一种表单认证，借用了Spring Security的认证管理器。Spring Security中提供了默认的登陆表单界面和配套的服务，只要在Spring Security的Web安全中简单配置即可启用：")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Configuration")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@EnableWebSecurity")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebSecurityConfig")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebSecurityConfigurerAdapter")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("configure")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpSecurity")]),t._v(" http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        http"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("authorizeRequests")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("antMatchers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("permitAll")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 首页地址'/'的请求都允许访问")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("anyRequest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("authenticated")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 任何请求,登录后才可以访问")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("and")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("formLogin")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 启用表单登录认证，还有另一种httpBasic()方法代表了HTTP基础认证")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("permitAll")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 登录页面用户任意访问")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("and")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("logout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("permitAll")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注销的服务任意访问")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("    \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("Spring Security的权限控制措施在两个层面进行，一种Web级别的访问控制，这是在Web服务器中附加的过滤器（FilterSecurityInterceptor）实现的，另一种是方法级权限控制，是通过动态代理实现的。第二种将在下一节“授权”部分中提及，这里先来说第一种。")]),t._v(" "),n("p",[t._v("当Spring Security被启动时（在Spring Boot中通过@EnableWebSecurity注解启动），将会在Web服务器中附加十几个不同作用的过滤器，譬如上面代码就直接涉及到其中三个：")]),t._v(" "),n("ul",[n("li",[t._v("SecurityContextPersistenceFilter：用于维护安全上下文，“上下文”说白了就是如果用户登陆了系统，那服务的代码中总该有个地放可以取到当前登陆用户是谁这类信息")]),t._v(" "),n("li",[t._v("UsernamePasswordAuthenticationFilter：用于完成用户名、密码的验证过程")]),t._v(" "),n("li",[t._v("LogoutFilter：用于注销")]),t._v(" "),n("li",[t._v("FilterSecurityInterceptor：用于Web级别的访问控制，如果设置了指定地址需要登陆而实际未登陆，或者设定了需要某些权限才能访问而实际用户并没有，那将抛出AuthenticationException与AccessDeniedException异常")])]),t._v(" "),n("p",[t._v("让我们再回到上面的代码，这段简单的工作流程是：")]),t._v(" "),n("ol",[n("li",[t._v("启用过滤器UsernamePasswordAuthenticationFilter，在其attemptAuthentication()方法中，会从Request中获取用户名和密码，传递给认证管理器AuthenticationManager的authenticate()方法")]),t._v(" "),n("li",[t._v("认证管理器的目的是协调不同的用户来源，譬如来自数据库、来自LDAP、来自OAuth等等，每一个用户来源都应该有一个实现了AuthenticationProvider接口并注册到认证管理器的实现类所代表，认证管理器将根据需要，调用对应Provider的authenticate()方法实际完成认证操作。")]),t._v(" "),n("li",[t._v("Spring Security默认的Provider是DaoAuthenticationProvider，它在Bookstore项目中并未被采用，而是另外实现了一个UsernamePasswordAuthenticationProvider。但是两者的实际逻辑是相似的，都是调用UserDetailsService接口里的loadUserByUsername()来获取用户信息，UserDetailsService是读取用户明细数据的接口，Spring Security并不关心用户系统的实际存储结构，但认证时肯定也必须使用到用户信息，默认使用InMemoryUserDetailsManager，也就是从内存中写死一些用户数据来完成。")]),t._v(" "),n("li",[t._v("在AuthenticationProvider中比较传入的用户密码与数据库中的用户密码是否一致（具体怎么个比较法将在“保密”这一节中说明），返回结果，完成认证。")])]),t._v(" "),n("p",[t._v("以上流程是大多数系统，尤其是单体系统中主流的认证方式，哪怕不基于Apache Shiro或Spring Security来实现，其思路很可能也是与上面描述的差不多的。但我们的Bookstore却并未直接应用这种认证方式，而是借用了OAuth2授权协议中的密码授权模式，在此过程中完成认证。为何会选择这种方式，以及具体实现部分的内容，将在下一部分“授权”中继续介绍。")])])}),[],!1,null,null,null);a.default=s.exports}}]);