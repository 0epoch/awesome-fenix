<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>服务安全 | 软件架构探索：The Fenix Project</title>
    <meta name="description" content="现代软件架构探索">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.b4f5acd1.css" as="style"><link rel="preload" href="/assets/js/app.3d52472e.js" as="script"><link rel="preload" href="/assets/js/3.c73306cd.js" as="script"><link rel="preload" href="/assets/js/5.f9a9e04d.js" as="script"><link rel="preload" href="/assets/js/100.f3a7f781.js" as="script"><link rel="preload" href="/assets/js/23.b19d616b.js" as="script"><link rel="prefetch" href="/assets/js/1.9163e30a.js"><link rel="prefetch" href="/assets/js/10.88774e6c.js"><link rel="prefetch" href="/assets/js/101.38a8d11d.js"><link rel="prefetch" href="/assets/js/102.d7fe43cd.js"><link rel="prefetch" href="/assets/js/103.a153f2fd.js"><link rel="prefetch" href="/assets/js/104.d760158a.js"><link rel="prefetch" href="/assets/js/105.480848b5.js"><link rel="prefetch" href="/assets/js/106.16963c22.js"><link rel="prefetch" href="/assets/js/107.ca70c593.js"><link rel="prefetch" href="/assets/js/108.1f72af34.js"><link rel="prefetch" href="/assets/js/109.58182895.js"><link rel="prefetch" href="/assets/js/11.8172a728.js"><link rel="prefetch" href="/assets/js/110.c2e92ac0.js"><link rel="prefetch" href="/assets/js/111.3dc91b2c.js"><link rel="prefetch" href="/assets/js/112.58fc0339.js"><link rel="prefetch" href="/assets/js/113.89f6ec02.js"><link rel="prefetch" href="/assets/js/114.34738805.js"><link rel="prefetch" href="/assets/js/115.d9c9128e.js"><link rel="prefetch" href="/assets/js/116.4221ce2f.js"><link rel="prefetch" href="/assets/js/117.dda84e78.js"><link rel="prefetch" href="/assets/js/118.71d22507.js"><link rel="prefetch" href="/assets/js/119.af88ccd0.js"><link rel="prefetch" href="/assets/js/12.b243e8e4.js"><link rel="prefetch" href="/assets/js/120.08a21fc5.js"><link rel="prefetch" href="/assets/js/121.9c6c83d9.js"><link rel="prefetch" href="/assets/js/122.d6686569.js"><link rel="prefetch" href="/assets/js/123.ceb230bd.js"><link rel="prefetch" href="/assets/js/124.9d2c01b6.js"><link rel="prefetch" href="/assets/js/125.384bdff5.js"><link rel="prefetch" href="/assets/js/126.19ab4096.js"><link rel="prefetch" href="/assets/js/127.8825b600.js"><link rel="prefetch" href="/assets/js/128.2d3575f6.js"><link rel="prefetch" href="/assets/js/129.66e59f82.js"><link rel="prefetch" href="/assets/js/13.1374643b.js"><link rel="prefetch" href="/assets/js/130.24dca140.js"><link rel="prefetch" href="/assets/js/131.3429366a.js"><link rel="prefetch" href="/assets/js/132.872292f6.js"><link rel="prefetch" href="/assets/js/133.bd2ab24f.js"><link rel="prefetch" href="/assets/js/134.90668069.js"><link rel="prefetch" href="/assets/js/135.8bd97c9a.js"><link rel="prefetch" href="/assets/js/136.3f4dd36d.js"><link rel="prefetch" href="/assets/js/137.5624656c.js"><link rel="prefetch" href="/assets/js/138.1450c90f.js"><link rel="prefetch" href="/assets/js/139.d195f41e.js"><link rel="prefetch" href="/assets/js/14.77b6a07b.js"><link rel="prefetch" href="/assets/js/140.19d9599e.js"><link rel="prefetch" href="/assets/js/141.e5b1b6d3.js"><link rel="prefetch" href="/assets/js/142.3d659b31.js"><link rel="prefetch" href="/assets/js/143.9155a29c.js"><link rel="prefetch" href="/assets/js/144.2752e142.js"><link rel="prefetch" href="/assets/js/145.8bde7d2e.js"><link rel="prefetch" href="/assets/js/146.ba0d263b.js"><link rel="prefetch" href="/assets/js/147.835fdb1e.js"><link rel="prefetch" href="/assets/js/148.c0701c02.js"><link rel="prefetch" href="/assets/js/149.07b6fe1a.js"><link rel="prefetch" href="/assets/js/15.9d2cb11a.js"><link rel="prefetch" href="/assets/js/150.6d0de725.js"><link rel="prefetch" href="/assets/js/151.686c4489.js"><link rel="prefetch" href="/assets/js/152.e11f89fd.js"><link rel="prefetch" href="/assets/js/153.bb9de911.js"><link rel="prefetch" href="/assets/js/154.dfdc090f.js"><link rel="prefetch" href="/assets/js/16.999ff5b5.js"><link rel="prefetch" href="/assets/js/17.bf94a86e.js"><link rel="prefetch" href="/assets/js/18.a9934626.js"><link rel="prefetch" href="/assets/js/19.511cfd00.js"><link rel="prefetch" href="/assets/js/20.0776a52b.js"><link rel="prefetch" href="/assets/js/21.6aa01789.js"><link rel="prefetch" href="/assets/js/22.9fd40546.js"><link rel="prefetch" href="/assets/js/24.6377778b.js"><link rel="prefetch" href="/assets/js/25.a7495b1e.js"><link rel="prefetch" href="/assets/js/26.651742f9.js"><link rel="prefetch" href="/assets/js/27.de3e0b1f.js"><link rel="prefetch" href="/assets/js/28.dc696746.js"><link rel="prefetch" href="/assets/js/29.071f6a9d.js"><link rel="prefetch" href="/assets/js/30.472a2563.js"><link rel="prefetch" href="/assets/js/31.8a6dd696.js"><link rel="prefetch" href="/assets/js/32.07d6b284.js"><link rel="prefetch" href="/assets/js/33.abe7702b.js"><link rel="prefetch" href="/assets/js/34.8b78cda9.js"><link rel="prefetch" href="/assets/js/35.18ea7cbe.js"><link rel="prefetch" href="/assets/js/36.142034ed.js"><link rel="prefetch" href="/assets/js/37.e7a463ef.js"><link rel="prefetch" href="/assets/js/38.43796c03.js"><link rel="prefetch" href="/assets/js/39.2720dbf0.js"><link rel="prefetch" href="/assets/js/4.bdc9e3da.js"><link rel="prefetch" href="/assets/js/40.4c33be53.js"><link rel="prefetch" href="/assets/js/41.e2d9e96d.js"><link rel="prefetch" href="/assets/js/42.1d81a7a3.js"><link rel="prefetch" href="/assets/js/43.987f6071.js"><link rel="prefetch" href="/assets/js/44.7570b902.js"><link rel="prefetch" href="/assets/js/45.b5436d3e.js"><link rel="prefetch" href="/assets/js/46.a66da3d2.js"><link rel="prefetch" href="/assets/js/47.8d1ae06c.js"><link rel="prefetch" href="/assets/js/48.f0d2d2a1.js"><link rel="prefetch" href="/assets/js/49.bd8c7ee9.js"><link rel="prefetch" href="/assets/js/50.e3432b0b.js"><link rel="prefetch" href="/assets/js/51.c3e66a22.js"><link rel="prefetch" href="/assets/js/52.48218ddf.js"><link rel="prefetch" href="/assets/js/53.73da637c.js"><link rel="prefetch" href="/assets/js/54.66f5a3ba.js"><link rel="prefetch" href="/assets/js/55.5cd6fb8d.js"><link rel="prefetch" href="/assets/js/56.51868adc.js"><link rel="prefetch" href="/assets/js/57.c0d1a21c.js"><link rel="prefetch" href="/assets/js/58.60a55c65.js"><link rel="prefetch" href="/assets/js/59.60ce5d77.js"><link rel="prefetch" href="/assets/js/6.86880ae8.js"><link rel="prefetch" href="/assets/js/60.a45da182.js"><link rel="prefetch" href="/assets/js/61.f933e6d9.js"><link rel="prefetch" href="/assets/js/62.c2c5e5e0.js"><link rel="prefetch" href="/assets/js/63.94ee055b.js"><link rel="prefetch" href="/assets/js/64.1c65b1fc.js"><link rel="prefetch" href="/assets/js/65.8d0f5435.js"><link rel="prefetch" href="/assets/js/66.de675cb6.js"><link rel="prefetch" href="/assets/js/67.9b2ed897.js"><link rel="prefetch" href="/assets/js/68.10fcf21b.js"><link rel="prefetch" href="/assets/js/69.4fa41891.js"><link rel="prefetch" href="/assets/js/7.9fad7e8b.js"><link rel="prefetch" href="/assets/js/70.0ab6b5f8.js"><link rel="prefetch" href="/assets/js/71.2601e94f.js"><link rel="prefetch" href="/assets/js/72.3862d99e.js"><link rel="prefetch" href="/assets/js/73.f2e92fe6.js"><link rel="prefetch" href="/assets/js/74.d0c0e0f5.js"><link rel="prefetch" href="/assets/js/75.76f9297a.js"><link rel="prefetch" href="/assets/js/76.23993551.js"><link rel="prefetch" href="/assets/js/77.4469861d.js"><link rel="prefetch" href="/assets/js/78.ade33005.js"><link rel="prefetch" href="/assets/js/79.f5686566.js"><link rel="prefetch" href="/assets/js/8.ba86c5be.js"><link rel="prefetch" href="/assets/js/80.acdc7411.js"><link rel="prefetch" href="/assets/js/81.680b6f97.js"><link rel="prefetch" href="/assets/js/82.17f1f819.js"><link rel="prefetch" href="/assets/js/83.cb931b96.js"><link rel="prefetch" href="/assets/js/84.ad550363.js"><link rel="prefetch" href="/assets/js/85.e41712ad.js"><link rel="prefetch" href="/assets/js/86.cb98ebeb.js"><link rel="prefetch" href="/assets/js/87.b6ad6814.js"><link rel="prefetch" href="/assets/js/88.a9a77e63.js"><link rel="prefetch" href="/assets/js/89.65293541.js"><link rel="prefetch" href="/assets/js/9.878b160a.js"><link rel="prefetch" href="/assets/js/90.f3002f19.js"><link rel="prefetch" href="/assets/js/91.0c52175b.js"><link rel="prefetch" href="/assets/js/92.0b2a9001.js"><link rel="prefetch" href="/assets/js/93.f9219d14.js"><link rel="prefetch" href="/assets/js/94.bebab12a.js"><link rel="prefetch" href="/assets/js/95.b93d1616.js"><link rel="prefetch" href="/assets/js/96.7cbf257f.js"><link rel="prefetch" href="/assets/js/97.a5360125.js"><link rel="prefetch" href="/assets/js/98.7d0f3c62.js"><link rel="prefetch" href="/assets/js/99.bb1f6337.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b4f5acd1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo-color.png" alt="软件架构探索：The Fenix Project" class="logo"> <span class="site-name can-hide">软件架构探索：The Fenix Project</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码" class="dropdown-title"><span class="title">代码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/awesome-fenix" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文档工程 Awesome-Fenix
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/fenix-bookstore-frontend" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://bookstore.icyfenix.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程在线示例 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/monolithic_arch_springboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：单体架构 Spring Boot
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_springcloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Spring Cloud
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_kubernetes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Kubernetes
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/servicemesh_arch_istio" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Istio
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/serverless_arch" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：无服务架构 Serverless
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://icyfenix.cn/pdf/the-fenix-project.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  PDF下载
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/board.html" class="nav-link">
  讨论区
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码" class="dropdown-title"><span class="title">代码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/awesome-fenix" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文档工程 Awesome-Fenix
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/fenix-bookstore-frontend" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://bookstore.icyfenix.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程在线示例 Fenix's Bookstore
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/monolithic_arch_springboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：单体架构 Spring Boot
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_springcloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Spring Cloud
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_kubernetes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Kubernetes
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/servicemesh_arch_istio" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Istio
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/serverless_arch" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：无服务架构 Serverless
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="https://icyfenix.cn/pdf/the-fenix-project.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  PDF下载
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/board.html" class="nav-link">
  讨论区
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/summary/" class="sidebar-link">目录</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/introduction/about-me.html" class="sidebar-link">✔️ 关于作者</a></li><li><a href="/introduction/about-the-fenix-project.html" class="sidebar-link">✔️ 什么是“The Fenix Project”</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>探索起步</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>阅读指引</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/changelog/" class="sidebar-link">✔️ 更新日志</a></li><li><a href="/exploration/guide/quick-start.html" class="sidebar-link">✔️ 如何开始</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/exploration/projects/" class="sidebar-heading clickable"><span>✔️ 技术演示工程</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/exploration/projects/fenix-bookstore-frontend.html" class="sidebar-link">✔️ 前端工程</a></li><li><a href="/exploration/projects/monolithic_arch_springboot.html" class="sidebar-link">✔️ 单体架构：Spring Boot</a></li><li><a href="/exploration/projects/microservice_arch_springcloud.html" class="sidebar-link">✔️ 微服务：Spring Cloud</a></li><li><a href="/exploration/projects/microservice_arch_kubernetes.html" class="sidebar-link">✔️ 微服务：Kubernetes</a></li><li><a href="/exploration/projects/servicemesh_arch_istio.html" class="sidebar-link">✔️ 服务网格：Istio</a></li><li><a href="/exploration/projects/serverless_arch.html" class="sidebar-link">✔️ 无服务：Serverless</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>演进中的架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/architecture/architect-history/" class="sidebar-heading clickable open"><span>✔️ 服务架构演进史</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/architect-history/primitive-distribution.html" class="sidebar-link">✔️ 原始分布式时代</a></li><li><a href="/architecture/architect-history/monolithic.html" class="sidebar-link">✔️ 单体系统时代</a></li><li><a href="/architecture/architect-history/soa.html" class="sidebar-link">✔️ SOA时代</a></li><li><a href="/architecture/architect-history/microservices.html" class="sidebar-link">✔️ 微服务时代</a></li><li><a href="/architecture/architect-history/post-microservices.html" class="sidebar-link">✔️ 后微服务时代</a></li><li><a href="/architecture/architect-history/serverless.html" class="sidebar-link">✔️ 无服务时代</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>架构师的视角</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/api-style/" class="sidebar-heading clickable open"><span>✔️ 远程访问</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/api-style/rpc.html" class="sidebar-link">✔️ 远程服务调用</a></li><li><a href="/architect-perspective/general-architecture/api-style/rest.html" class="sidebar-link">✔️ RESTful服务</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/transaction/" class="sidebar-heading clickable"><span>✔️ 事务处理</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/transaction/local.html" class="sidebar-link">✔️ 本地事务</a></li><li><a href="/architect-perspective/general-architecture/transaction/global.html" class="sidebar-link">✔️ 全局事务</a></li><li><a href="/architect-perspective/general-architecture/transaction/share.html" class="sidebar-link">✔️ 共享事务</a></li><li><a href="/architect-perspective/general-architecture/transaction/distributed.html" class="sidebar-link">✔️ 分布式事务</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/diversion-system/" class="sidebar-heading clickable"><span>✔️ 透明多级分流系统</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/diversion-system/client-cache.html" class="sidebar-link">✔️ 客户端缓存</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/dns-lookup.html" class="sidebar-link">✔️ 域名解析</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/transmission-optimization.html" class="sidebar-link">✔️ 传输链路</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/cdn.html" class="sidebar-link">✔️ 内容分发网络</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/load-balancing.html" class="sidebar-link">✔️ 负载均衡</a></li><li><a href="/architect-perspective/general-architecture/diversion-system/cache-middleware.html" class="sidebar-link">✔️ 缓存</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture/system-security/" class="sidebar-heading clickable"><span>✔️ 安全架构</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/system-security/authentication.html" class="sidebar-link">✔️ 认证</a></li><li><a href="/architect-perspective/general-architecture/system-security/authorization.html" class="sidebar-link">✔️ 授权</a></li><li><a href="/architect-perspective/general-architecture/system-security/credentials.html" class="sidebar-link">✔️ 凭证</a></li><li><a href="/architect-perspective/general-architecture/system-security/confidentiality.html" class="sidebar-link">✔️ 保密</a></li><li><a href="/architect-perspective/general-architecture/system-security/transport-security.html" class="sidebar-link">✔️ 传输</a></li><li><a href="/architect-perspective/general-architecture/system-security/verification.html" class="sidebar-link">✔️ 验证</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>分布式的基石</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/consensus/" class="sidebar-heading clickable"><span>✔️ 分布式共识算法</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/consensus/paxos.html" class="sidebar-link">✔️ Paxos</a></li><li><a href="/distribution/consensus/raft.html" class="sidebar-link">✔️ Multi Paxos与Raft</a></li><li><a href="/distribution/consensus/gossip.html" class="sidebar-link">✔️ Gossip协议</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/connect/" class="sidebar-heading clickable"><span>✔️ 从类库到服务</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/connect/service-discovery.html" class="sidebar-link">✔️ 服务发现</a></li><li><a href="/distribution/connect/service-routing.html" class="sidebar-link">✔️ 网关路由</a></li><li><a href="/distribution/connect/load-balancing.html" class="sidebar-link">✔️ 客户端负载均衡</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/traffic-management/" class="sidebar-heading clickable"><span>✔️ 服务与流量治理</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/traffic-management/failure.html" class="sidebar-link">✔️ 服务容错</a></li><li><a href="/distribution/traffic-management/traffic-control.html" class="sidebar-link">✔️ 流量控制</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/distribution/secure/" class="sidebar-heading clickable router-link-active open"><span>✔️ 可靠通讯</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/secure/zero-trust.html" class="sidebar-link">✔️ 零信任网络</a></li><li><a href="/distribution/secure/service-security.html" class="active sidebar-link">✔️ 服务安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/distribution/secure/service-security.html#建立信任" class="sidebar-link">建立信任</a></li><li class="sidebar-sub-header"><a href="/distribution/secure/service-security.html#认证" class="sidebar-link">认证</a></li><li class="sidebar-sub-header"><a href="/distribution/secure/service-security.html#授权" class="sidebar-link">授权</a></li></ul></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>可观测性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/distribution/observability/logging.html" class="sidebar-link">日志聚合</a></li><li><a href="/distribution/observability/invokechain-trace.html" class="sidebar-link">链路跟踪</a></li><li><a href="/distribution/observability/apm.html" class="sidebar-link">应用性能管理</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>不可变基础设施</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/history.html" class="sidebar-link">虚拟化的概念与历史</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/container/" class="sidebar-heading clickable"><span>虚拟化容器</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/container/cri.html" class="sidebar-link">CRI接口</a></li><li><a href="/immutable-infrastructure/container/resource-isolation.html" class="sidebar-link">资源隔离</a></li><li><a href="/immutable-infrastructure/container/resource.html" class="sidebar-link">资源对象</a></li><li><a href="/immutable-infrastructure/container/manage.html" class="sidebar-link">容器管理</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/network/" class="sidebar-heading clickable"><span>容器间网络</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/network/cni.html" class="sidebar-link">CNI接口</a></li><li><a href="/immutable-infrastructure/network/strategy.html" class="sidebar-link">网络策略</a></li><li><a href="/immutable-infrastructure/network/plugin.html" class="sidebar-link">网络插件</a></li><li><a href="/immutable-infrastructure/network/container-lb.html" class="sidebar-link">容器负载均衡</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/storage/" class="sidebar-heading clickable"><span>配置与数据持久化</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/storage/csi.html" class="sidebar-link">CSI接口</a></li><li><a href="/immutable-infrastructure/storage/dfs.html" class="sidebar-link">分布式文件系统</a></li><li><a href="/immutable-infrastructure/storage/storage-plugins.html" class="sidebar-link">共享存储插件</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/gpu/" class="sidebar-heading clickable"><span>GPU虚拟化</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/gpu/device-plugin.html" class="sidebar-link">Device Plugin机制</a></li><li><a href="/immutable-infrastructure/gpu/gpu-schedule.html" class="sidebar-link">调度GPU</a></li><li><a href="/immutable-infrastructure/gpu/nvidia.html" class="sidebar-link">Nvidia插件</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/extension/" class="sidebar-heading clickable"><span>扩展基础设施</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/extension/crd.html" class="sidebar-link">CRD定义</a></li><li><a href="/immutable-infrastructure/extension/api-server.html" class="sidebar-link">自定义API Server</a></li></ul></section></li><li><a href="/immutable-infrastructure/hardware-schedule.html" class="sidebar-link">硬件资源调度</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>设计方法论</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/methodology/layered-system.html" class="sidebar-link">系统分层</a></li><li><a href="/methodology/capacity-design.html" class="sidebar-link">容量规划</a></li><li><a href="/methodology/constraint.html" class="sidebar-link">非功能属性设计</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>技巧与专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/tricks/graalvm/" class="sidebar-heading clickable open"><span>✔️ Graal VM</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/tricks/graalvm/graal-compiler.html" class="sidebar-link">✔️ 新一代即时编译器</a></li><li><a href="/tricks/graalvm/substratevm.html" class="sidebar-link">✔️ 向原生迈进</a></li><li><a href="/tricks/graalvm/graalvm-native.html" class="sidebar-link">✔️ 没有虚拟机的Java</a></li><li><a href="/tricks/graalvm/spring-over-graal.html" class="sidebar-link">✔️ Spring over Graal</a></li></ul></section></li><li><a href="/tricks/responsive-programming.html" class="sidebar-link">响应式编程</a></li><li><a href="/tricks/lambda-stream.html" class="sidebar-link">函数式接口与流式编程思想</a></li><li><a href="/tricks/aio.html" class="sidebar-link">并行、异步、非阻塞</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>附录</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/appendix/build-script.html" class="sidebar-link">构建发布脚本</a></li><li><a href="/appendix/continuous-integration.html" class="sidebar-link">持续集成</a></li><li><a href="/appendix/gated-launch.html" class="sidebar-link">灰度发布</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/appendix/deployment-env-setup/" class="sidebar-heading clickable"><span>✔️ 环境依赖</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/appendix/deployment-env-setup/setup-docker.html" class="sidebar-link">✔️ 部署Docker CE容器环境</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/appendix/deployment-env-setup/setup-kubernetes/" class="sidebar-heading clickable"><span>✔️ 部署Kubernetes集群</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/appendix/operation-env-setup/" class="sidebar-heading clickable"><span>运维环境</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="服务安全">服务安全</h1> <div class="custom-block tip"><p class="custom-block-title">前置知识</p> <p>本文涉及到SSL/TLS、PKI、CA、OAuth2、RBAC、JWT等概念，直接依赖于“安全架构”部分的<a href="/architect-perspective/general-architecture/system-security/authentication.html">认证</a>、<a href="/architect-perspective/general-architecture/system-security/authorization.html">授权</a>、<a href="/architect-perspective/general-architecture/system-security/credentials.html">凭证</a>、<a href="/architect-perspective/general-architecture/system-security/transport-security.html">传输</a>四节对安全基础知识的铺垫，这四篇文章中介绍过的内容，笔者在本篇中将不再重复，建议读者先行阅读。</p></div> <p>在“<a href="/architect-perspective/general-architecture/system-security/">安全架构</a>”部分，我们了解过那些跟具体架构形式无关的、业界主流的安全概念和技术标准，在上一节“<a href="/distribution/secure/zero-trust.html">零信任网络</a>”里，我们立足于微服务架构，探讨了与微服务运作特点相适应的安全模型。在本文中，我们将从实践和编码的角度出发，探讨在微服务架构下，如何将业界的安全技术标准引入并实际落地，实现零信任网络下安全的服务访问。</p> <h2 id="建立信任">建立信任</h2> <p>零信任网络里不存在默认的信任关系，一切服务调用、资源访问成功与否，均需以调用者与提供者间已建立的信任关系为前提。此前我们<a href="/architect-perspective/general-architecture/system-security/transport-security.html#数字证书">曾讨论过</a>，真实世界里，能够达成信任的基本途径不外乎<code>基于共同私密信息的信任</code>和<code>基于权威公证人的信任</code>两种；网络世界里，因为客户端和服务端之间并没有什么共同私密信息，所以真正能采用的就只能是基于权威公证人的信任，它有个标准的名字：<a href="https://zh.wikipedia.org/wiki/%E5%85%AC%E9%96%8B%E9%87%91%E9%91%B0%E5%9F%BA%E7%A4%8E%E5%BB%BA%E8%A8%AD" target="_blank" rel="noopener noreferrer">公开密钥基础设施<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Public Key Infrastructure，PKI）。</p> <p>PKI是构建<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank" rel="noopener noreferrer">传输安全层<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Transport Layer Security，TLS）的必要基础。在任何网络设施都不可信任的假设前提下，无论是DNS、代理服务器、负载均衡器还是路由器，传输路径上的每一个节点都有可能监听或者篡改通讯双方传输的信息。要保证通讯过程不受到中间人攻击的威胁，启用TLS对传输通道本身进行加密，让发送者发出的内容只有接受者可以解密是<strong>唯一</strong>具备可行性的方案。建立TLS传输，说起来似乎不复杂，只要在部署服务器时预置好CA根证书，以后用该CA为部署的服务签发TLS证书便是。但落到实际操作上，这事情就属于典型的“必须集中在基础设施中自动进行的安全策略实施点”，面对数量庞大且能够自动扩缩的服务节点，依赖运维人员人工去部署和轮换根证书必定是难以为继的。除了服务节点扩缩与数量带来的复杂性外，微服务中TLS认证的频次也会显著高于传统的应用，比起公众互联网中主流单向的TLS认证，在零信任网络中，往往要启用<a href="https://en.wikipedia.org/wiki/Mutual_authentication" target="_blank" rel="noopener noreferrer">双向的TLS认证<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Mutual TLS，常简写为mTLS），即不仅要确认服务端的身份，还需要确认调用者的身份。</p> <ul><li><strong>单向TLS认证</strong>：只需要服务端提供证书，客户端通过服务端证书验证服务器的身份，但服务器并不验证客户端的身份。单向TLS用于公开的服务，即任何客户端都被允许连接到服务进行访问，它保护的是客户端免遭冒牌服务器的欺骗。</li> <li><strong>双向TLS认证</strong>：客户端、服务端双方都要提供证书，双方各自通过对方提供的证书来验证对方的身份。双向TLS用于私密的服务，即服务只允许特定身份的客户端访问，它除了保护客户端不连接到冒牌服务器外，也保护服务端不遭到非法用户的越权访问。</li></ul> <p>对于以上提到的围绕TLS而展开的密钥生成、证书分发、<a href="https://en.wikipedia.org/wiki/Certificate_signing_request" target="_blank" rel="noopener noreferrer">签名请求<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Certificate Signing Request，CSR）、更新轮换等是一套非常繁琐的流程，稍有疏忽就会产生安全漏洞，所以尽管理论上可行，但实践中如果没有自动化的基础设施的支持，仅靠应用程序和运维人员的努力，是很难成功实施零信任安全模型的。</p> <p>关于自动化基础设施在密钥、证书等方面该提供哪些支持、具体是如何运作的，我们还会在“不可变基础设施”中继续去探讨，这里先聚焦“认证”和“授权”两个最基本的安全需求，看它们在微服务架构下，有或者没有基础设施支持时，各是如何实现的。</p> <h2 id="认证">认证</h2> <p>根据认证的目标对象可以把认证分为两种类型，一种是以机器作为认证对象，即访问服务的流量来源是另外一个服务，称为服务认证（Peer Authentication）；另一种是以人类作为认证对象，即访问服务的流量来自于最终用户，称为请求认证（Request Authentication）。无论哪一种认证，无论是否没有基础设施的支持，均需要有可行的方案来确定服务调用者的身份，建立起信任关系才能调用服务，我们先从服务认证说起。</p> <h3 id="服务认证">服务认证</h3> <p>Istio版本的Fenix's Bookstore采用了双向TLS认证作为服务调用双方的身份认证手段。得益于Istio提供的基础设施的支持，我们无需改动任何代码就可以启用mTLS认证。不过，如果你准备在自己的生产系统中启用mTLS，要先想一下是否整个服务集群都受Istio管理？如果每一个服务提供者、调用者均受Istio管理，那mTLS就是最理想的认证方案，没有之一。你只需要参考以下简单的PeerAuthentication <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank" rel="noopener noreferrer">CRD<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>配置，即可对某个<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/" target="_blank" rel="noopener noreferrer">Kubernetes名空间<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>范围内所有的流量均启用mTLS：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PeerAuthentication
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authentication<span class="token punctuation">-</span>mtls
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> bookstore<span class="token punctuation">-</span>servicemesh
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">mtls</span><span class="token punctuation">:</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> STRICT
</code></pre></div><p>如果你的分布式系统中存在不受Istio管理（即未注入Sidecar）的服务端或者客户端——这其实在大型系统中是颇为常见的，你也可以将传输声明为“宽容模式”（Permissive Mode）。宽容模式的含义是受Istio管理的服务会允许同时接受纯文本和mTLS两种流量，纯文本流量仅用于与那些不受Istio管理的节点进行交互，你需要自行想办法解决纯文本流量的认证问题；而对于服务网格内部的流量，就可以使用mTLS认证。宽容模式为普通微服务向服务网格迁移提供了极大的灵活性，运维人员能够逐个服务进行mTLS升级，原本没有启用mTLS的服务在启用mTLS时甚至允许不中断现存已建立的纯文本传输连接。一旦所有服务都完成迁移，便可将整个系统设置为严格TLS模式（即上面代码中的mode: STRICT）。</p> <p>在Spring Cloud版本的Fenix's Bookstore里，因为没有基础设施的支持，一切认证工作就不得不在应用层面去实现。笔者选择的方案是借用<a href="/architect-perspective/general-architecture/system-security/authorization.html#oauth2">OAtuh2授权协议</a>的客户端模式来进行认证，其大体思路有如下两步：</p> <ul><li>每一个要调用服务的客户端都与认证服务器约定好一组只有自己知道的密钥（Client Secret），这个约定过程应该是由运维人员在线下自行完成，通过参数传给服务（而不是由开发人员在源码或配置文件中直接设定，笔者在演示工程的代码注释中也专门强调了这点，以免有读者被示例代码误导）。密钥就是客户端的身份证明，客户端调用服务时，会先使用该密钥向认证服务器申请到JWT令牌。如以下代码定义了五个客户端，其中四个是集群内部的微服务，均使用客户端模式，且注明了授权范围是“SERVICE”（后面介绍授权会用到）。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 客户端列表
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Client</span><span class="token punctuation">&gt;</span></span> clients <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token string">&quot;bookstore_frontend&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bookstore_secret&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">GrantType</span><span class="token punctuation">.</span>PASSWORD<span class="token punctuation">,</span> <span class="token class-name">GrantType</span><span class="token punctuation">.</span>REFRESH_TOKEN<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Scope</span><span class="token punctuation">.</span>BROWSER<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 微服务一共有Security微服务、Account微服务、Warehouse微服务、Payment微服务四个客户端</span>
    <span class="token comment">// 如果正式使用，这部分信息应该做成可以配置的，以便快速增加微服务的类型。clientSecret也不应该出现在源码中，应由外部配置传入</span>
    <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;account_secret&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">GrantType</span><span class="token punctuation">.</span>CLIENT_CREDENTIALS<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Scope</span><span class="token punctuation">.</span>SERVICE<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token string">&quot;warehouse&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;warehouse_secret&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">GrantType</span><span class="token punctuation">.</span>CLIENT_CREDENTIALS<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Scope</span><span class="token punctuation">.</span>SERVICE<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token string">&quot;payment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;payment_secret&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">GrantType</span><span class="token punctuation">.</span>CLIENT_CREDENTIALS<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Scope</span><span class="token punctuation">.</span>SERVICE<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token string">&quot;security&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;security_secret&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">GrantType</span><span class="token punctuation">.</span>CLIENT_CREDENTIALS<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Scope</span><span class="token punctuation">.</span>SERVICE<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>每一个对外提供服务的服务端都是OAuth2中的资源服务器，它们均声明为要求提供客户端模式的凭证，如以下代码所示。客户端要调用受保护的服务，就必须先出示能证明调用者身份的JWT令牌，否则就会遭到拒绝。这个操作本质上是授权，但是在授权过程中也已实现了身份认证。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ClientCredentialsResourceDetails</span> <span class="token function">clientCredentialsResourceDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClientCredentialsResourceDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于每一个微服务都同时具有服务端和客户端两种身份，所以这些代码在每个微服务中都有包含（放在公共infrastructure工程里）。Spring Security提供的过滤器会自动拦截请求，驱动认证、授权检查的执行，申请和验证JWT令牌等操作无论在开发期对程序员，还是运行期对用户都能做到相对透明。尽管如此，以上仍然是一种应用层面的、不加密传输的解决方案。前文提到在零信任网络中，面对可能的中间人攻击，TLS是唯一可行的办法，言下之意是即使应用层的认证能一定程度上保护服务不被身份不明的客户端越权调用，但对传输过程中内容被监听、篡改、以及被攻击者在传输途中拿到JWT令牌后去再冒认调用者身份调用其他服务都是无法防御的。简而言之，这种方案不适用于零信任安全模型，只能在默认内网节点间具备信任关系的边界安全模型上才能良好工作。</p> <h3 id="用户认证">用户认证</h3> <p>对于来自最终用户的请求认证，Istio版本的Fenix's Bookstore仍然能做到单纯依靠基础设施解决问题，整个认证过程无需应用程序参与（生成JWT令牌还是在应用中生成的，因为我们并没有使用独立的用户认证服务器，只有应用本身才拥有用户信息）。当来自最终用户的请求进入服务网格时，Istio会自动根据配置中的<a href="https://tools.ietf.org/html/rfc7517" target="_blank" rel="noopener noreferrer">JWKS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（JSON Web Key Set）来验证令牌的合法性，如果令牌没有被篡改过且在有效期内，就信任Payload中的用户身份，并从令牌的Iss字段中获得Principal。</p> <p>关于Iss、Principals等概念，在<a href="/architect-perspective/general-architecture/system-security/">安全架构</a>中都有介绍过，这里不再重复。JWKS倒是之前没有提到过的概念，它代表了一个密钥仓库。我们知道分布式系统中，JWT应采用非对称的签名算法（RSA SHA256、ECDSA SHA256等，默认的HMAC SHA256属于对称加密），认证服务器使用私钥对Payload进行签名，资源服务器使用公钥对签名进行验证。常与JWT配合使用的JWK就是一种存储密钥的纯文本格式，本质上和<a href="https://en.wikipedia.org/wiki/Java_KeyStore" target="_blank" rel="noopener noreferrer">JKS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Java Key Storage）、<a href="https://en.wikipedia.org/wiki/PKCS_12" target="_blank" rel="noopener noreferrer">P12<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Predecessor of PKCS#12）、<a href="https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail" target="_blank" rel="noopener noreferrer">PEM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Privacy Enhanced Mail）这些常见的密钥格式在功能上并没有什么差别。JKWS顾名思义就是一组JWK的集合，通过JWT令牌Header中的KID（Key ID）来匹配使用哪个JWK做签名验证。</p> <p>以下是Istio版本的Fenix's Bookstore中的用户认证配置，其中“jwks”字段配的就是JWKS全文（实际生产中并不推荐这样做，应该使用jwksUri来配置一个JWKS地址，以方便密钥轮换），根据这里配置的密钥信息，Istio就能够验证请求中附带的JWT是否合法。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RequestAuthentication
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authentication<span class="token punctuation">-</span>jwt<span class="token punctuation">-</span>token
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> bookstore<span class="token punctuation">-</span>servicemesh
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">jwtRules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">issuer</span><span class="token punctuation">:</span> <span class="token string">&quot;icyfenix@gmail.com&quot;</span>
      <span class="token comment"># Envoy默认只认“Bearer”作为JWT前缀，之前其他地方用的都是小写，这里专门兼容一下</span>
      <span class="token key atrule">fromHeaders</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Authorization
          <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;bearer &quot;</span>
      <span class="token comment"># 在rsa-key目录下放了用来生成这个JWKS的证书，最初是用java keytool生成的jks格式，一般转jwks都是用pkcs12或者pem格式，为方便使用也一起附带了</span>
      <span class="token key atrule">jwks</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        {
            &quot;keys&quot;: [
                {
                    &quot;e&quot;: &quot;AQAB&quot;,
                    &quot;kid&quot;: &quot;bookstore-jwt-kid&quot;,
                    &quot;kty&quot;: &quot;RSA&quot;,
                    &quot;n&quot;: &quot;i-htQPOTvNMccJjOkCAzd3YlqBElURzkaeRLDoJYskyU59JdGO-p_q4JEH0DZOM2BbonGI4lIHFkiZLO4IBBZ5j2P7U6QYURt6-AyjS6RGw9v_wFdIRlyBI9D3EO7u8rCA4RktBLPavfEc5BwYX2Vb9wX6N63tV48cP1CoGU0GtIq9HTqbEQs5KVmme5n4XOuzxQ6B2AGaPBJgdq_K0ZWDkXiqPz6921X3oiNYPCQ22bvFxb4yFX8ZfbxeYc-1rN7PaUsK009qOx-qRenHpWgPVfagMbNYkm0TOHNOWXqukxE-soCDI_Nc--1khWCmQ9E2B82ap7IXsVBAnBIaV9WQ&quot;
                }
            ]
        }</span>
      <span class="token key atrule">forwardOriginalToken</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>Spring Cloud版本的Fenix's Bookstore就略微麻烦一些，它依然是采用JWT令牌作为用户身份凭证的载体，认证过程依然在Spring Security的过滤器里中自动完成（因讨论主题不在这里，详细过程就不表了，主要路径是过滤器→令牌服务→令牌实现）。Spring Security已经做好了认证所需的绝大部分的工作，真正要用户编写的代码就是令牌实现，即代码中名为<code>RSA256PublicJWTAccessToken</code>的实现类。它的作用是加载Resource目录下的公钥证书<code>public.cert</code>（实在是怕“抄作业不改名字”的行为，笔者再一次强调不要将密码、密钥、证书这类敏感信息打包到程序中，示例代码只是为了演示，实际生产应该由运维人员管理密钥），验证请求中的JWT令牌是否合法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Named</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RSA256PublicJWTAccessToken</span> <span class="token keyword">extends</span> <span class="token class-name">JWTAccessToken</span> <span class="token punctuation">{</span>
    <span class="token class-name">RSA256PublicJWTAccessToken</span><span class="token punctuation">(</span><span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;public.cert&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> publicKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">FileCopyUtils</span><span class="token punctuation">.</span><span class="token function">copyToByteArray</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setVerifierKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果JWT令牌合法，Spring Security的过滤器就会放行调用请求，并从令牌中提取出Principals，放到自己的安全上下文中（即<code>SecurityContextHolder.getContext()</code>）。开发实际项目时，你可以根据需要决定Principals的形式，即可以像Istio中那样直接从令牌中取出来，以字符串形式原样存放，节省一些数据库或者缓存的查询开销；也可以统一做些额外的转换处理，如将Principals转换自动为系统中用户对象以方便后续业务使用。Fenix's Bookstore转换操作是在JWT令牌的父类<code>JWTAccessToken</code>中完成的。由此可见，尽管由应用自己来做请求验证会有一定的代码量和侵入性，但灵活性确实也要更高一些。</p> <p>为方便不同版本实现之间的对比（偷懒少改代码），在Istio版本中保留了Spring Security自动从令牌转换Principals为用户对象的逻辑，因此必须在YAML中包含<code>forwardOriginalToken: true</code>的配置，告诉Istio验证完JWT令牌后不要丢弃掉请求中的Authorization Header，原样转发给后面的服务处理。</p> <h2 id="授权">授权</h2> <p>经过认证之后，合法的调用者就有了可信任的身份，此时就已经不再需要区分调用者到底是机器（服务）还是人类（最终用户）了，只根据其身份角色来进行权限访问控制，即我们常说的RBAC。不过为了更便于理解，Fenix's Bookstore提供的示例代码仍然沿用此前的思路，针对来自“服务”和“用户”的流量来控制权限和访问范围。</p> <p>举个具体例子，如果我们准备把一部分微服务视为私有服务，限制它只接受来自集群内部其他服务的请求，另外一部分微服务视为公共服务，允许它可接受来自集群外部的最终用户发出的请求；又或者我们想要控制一部分服务只允许移动应用调用，另外一部分服务只允许浏览器调用。那一种可行的方案就是为不同的调用场景设立角色，进行授权控制（另一种常用的方案是做BFF网关）。</p> <p>在Istio版本的Fenix's Bookstore中，通过以下配置，限制了来自<code>bookstore-servicemesh</code>名空间的内部流量只允许访问<code>accounts</code>、<code>products</code>、<code>pay</code>和<code>settlements</code>四个端点的GET、POST、PUT、PATCH方法，而对于来自<code>istio-system</code>名空间（Istio Ingress Gateway所在的名空间）的外部流量就不作限制，直接放行。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>peer
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> bookstore<span class="token punctuation">-</span>servicemesh
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">action</span><span class="token punctuation">:</span> ALLOW
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
            <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bookstore-servicemesh&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">to</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">operation</span><span class="token punctuation">:</span>
            <span class="token key atrule">paths</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> /restful/accounts/*
              <span class="token punctuation">-</span> /restful/products*
              <span class="token punctuation">-</span> /restful/pay/*
              <span class="token punctuation">-</span> /restful/settlements*
            <span class="token key atrule">methods</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;PUT&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;PATCH&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
            <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;istio-system&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>但对外部的请求（不来自<code>bookstore-servicemesh</code>名空间的流量），又进行了另外一层控制，如果请求中没有包含有效的登录信息，就限制不允许访问<code>accounts</code>、<code>pay</code>和<code>settlements</code>三个端点，如以下配置所示：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>request
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> bookstore<span class="token punctuation">-</span>servicemesh
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">action</span><span class="token punctuation">:</span> DENY
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
            <span class="token key atrule">notRequestPrincipals</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">]</span>
            <span class="token key atrule">notNamespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bookstore-servicemesh&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">to</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">operation</span><span class="token punctuation">:</span>
            <span class="token key atrule">paths</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> /restful/accounts/*
              <span class="token punctuation">-</span> /restful/pay/*
              <span class="token punctuation">-</span> /restful/settlements*
</code></pre></div><p>Istio已经提供了比较完善的目标匹配工具，如上面配置中用到的源<code>from</code>、目标<code>to</code>，还有未用到的条件匹配<code>when</code>，以及其他如通配符、IP、端口、名空间、JWT字段，等等。要说灵活和功能强大，肯定还是不可能跟在应用中由代码实现的授权相媲美，但对绝大多数场景已经够用了。在便捷性、安全性、无侵入、统一管理等方面，Istio这种在基础设施上实现授权方案显然要更具优势。</p> <p>Spring Cloud版本的Fenix's Bookstore中，授权控制自然还是使用Spring Security、通过应用程序代码来实现的。常见的Spring Security授权方法有两种，一种是使用它的<code>ExpressionUrlAuthorizationConfigurer</code>，即类似如下编码所示的写法来进行集中配置，这与上面在Istio的AuthorizationPolicy CRD中写法在体验上是非常相似的，这也是几乎所有Spring Security资料中都有介绍的最主流方式，适合对批量端点进行控制，不过在示例代码中并没有采用（没有什么特别原因，就是笔者的习惯而已）。</p> <div class="language-java extra-class"><pre class="language-java"><code>http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/restful/accounts/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasScope</span><span class="token punctuation">(</span><span class="token class-name">Scope</span><span class="token punctuation">.</span>BROWSER<span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/restful/pay/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasScope</span><span class="token punctuation">(</span><span class="token class-name">Scope</span><span class="token punctuation">.</span>SERVICE<span class="token punctuation">)</span>
</code></pre></div><p>另一种写法，也是实例代码中采用的方法通过是Spring的<a href="https://docs.spring.io/spring-security/site/docs/3.0.x/reference/el-access.html" target="_blank" rel="noopener noreferrer">全局方法级安全<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Global Method Security）以及JSR 250的<code>@RolesAllowed</code>注解来做授权控制。这种写法对代码的侵入性更强，但也能以更方便的形式做出更加精细的控制效果。譬如要控制服务中某个方法只允许来自服务或者来自浏览器的调用，只许直接在该方法上标注<code>@PreAuthorize</code>注解即可，支持<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/expressions.html" target="_blank" rel="noopener noreferrer">SpEL表达式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。表达式中用到的<code>SERVICE</code>、<code>BROWSER</code>代表授权范围，是在声明客户端列表时传入的（见开头声明客户端列表的代码清单）。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 根据用户名称获取用户详情
 */</span>
<span class="token annotation punctuation">@GET</span>
<span class="token annotation punctuation">@Path</span><span class="token punctuation">(</span><span class="token string">&quot;/{username}&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">&quot;#username&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;#oauth2.hasAnyScope('SERVICE','BROWSER')&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Account</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> service<span class="token punctuation">.</span><span class="token function">findAccountByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 创建新的用户
 */</span>
<span class="token annotation punctuation">@POST</span>
<span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">&quot;#user.username&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;#oauth2.hasAnyScope('BROWSER')&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Response</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@UniqueAccount</span> <span class="token class-name">Account</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token class-name">CommonResponse</span><span class="token punctuation">.</span><span class="token function">op</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> service<span class="token punctuation">.</span><span class="token function">createAccount</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="git-hub-star"><span class="prefix">
      Kudos to
      <span style="position:relative;top:4px;right:-4px;"><a href="https://github.com/fenixsoft/awesome-fenix" aria-label="Star fenixsoft/awesome-fenix on GitHub" data-icon="octicon-star" data-show-count="true">
      Star
    </a></span></span></div> <div class="last-updated"><span class="prefix">总字数:</span> <span class="words">5,345</span> <span class="prefix">字　</span> <span class="prefix">最后更新:</span> <span class="time">7/23/2020, 5:32:05 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
    ←
    <a href="/distribution/secure/zero-trust.html" class="prev">
      零信任网络
    </a></span> <span class="next"><a href="/distribution/observability/logging.html">
      日志聚合
    </a>
    →
  </span></p></div> </main></div><div class="global-ui"><div></div><!----></div></div>
    <script src="/assets/js/app.3d52472e.js" defer></script><script src="/assets/js/3.c73306cd.js" defer></script><script src="/assets/js/5.f9a9e04d.js" defer></script><script src="/assets/js/100.f3a7f781.js" defer></script><script src="/assets/js/23.b19d616b.js" defer></script>
  </body>
</html>
