<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>√ 使用Kubeadm部署 | 软件架构探索：The Fenix Project</title>
    <meta name="description" content="现代软件架构探索">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.7a3888f9.css" as="style"><link rel="preload" href="/assets/js/app.bf25c76c.js" as="script"><link rel="preload" href="/assets/js/2.d5b46b4e.js" as="script"><link rel="preload" href="/assets/js/7.681e02a5.js" as="script"><link rel="preload" href="/assets/js/5.797f2502.js" as="script"><link rel="prefetch" href="/assets/js/10.ce357394.js"><link rel="prefetch" href="/assets/js/11.acb01f3a.js"><link rel="prefetch" href="/assets/js/12.64f1f2bf.js"><link rel="prefetch" href="/assets/js/13.a28b7283.js"><link rel="prefetch" href="/assets/js/14.71e5e432.js"><link rel="prefetch" href="/assets/js/15.7276d91f.js"><link rel="prefetch" href="/assets/js/16.601fe74d.js"><link rel="prefetch" href="/assets/js/17.a99037d3.js"><link rel="prefetch" href="/assets/js/18.77a1763f.js"><link rel="prefetch" href="/assets/js/19.b8bed66d.js"><link rel="prefetch" href="/assets/js/20.c5b006af.js"><link rel="prefetch" href="/assets/js/21.306755cc.js"><link rel="prefetch" href="/assets/js/22.6e9d0f74.js"><link rel="prefetch" href="/assets/js/23.b9595b3d.js"><link rel="prefetch" href="/assets/js/24.d6310162.js"><link rel="prefetch" href="/assets/js/25.e46e0ade.js"><link rel="prefetch" href="/assets/js/26.131aee57.js"><link rel="prefetch" href="/assets/js/27.5ae46bc2.js"><link rel="prefetch" href="/assets/js/28.a417fc21.js"><link rel="prefetch" href="/assets/js/29.081fd8dc.js"><link rel="prefetch" href="/assets/js/3.1b201692.js"><link rel="prefetch" href="/assets/js/30.daa18b8c.js"><link rel="prefetch" href="/assets/js/31.a2d350b2.js"><link rel="prefetch" href="/assets/js/32.f45790d4.js"><link rel="prefetch" href="/assets/js/33.e96614a4.js"><link rel="prefetch" href="/assets/js/34.f5665896.js"><link rel="prefetch" href="/assets/js/35.9f367104.js"><link rel="prefetch" href="/assets/js/36.f3874119.js"><link rel="prefetch" href="/assets/js/37.4e2ab706.js"><link rel="prefetch" href="/assets/js/38.a8946723.js"><link rel="prefetch" href="/assets/js/39.5080c2cc.js"><link rel="prefetch" href="/assets/js/4.3de17ccc.js"><link rel="prefetch" href="/assets/js/40.4ca0922f.js"><link rel="prefetch" href="/assets/js/41.b741d741.js"><link rel="prefetch" href="/assets/js/42.7cac5357.js"><link rel="prefetch" href="/assets/js/43.435d3454.js"><link rel="prefetch" href="/assets/js/44.ae8b4d63.js"><link rel="prefetch" href="/assets/js/45.765b5d5f.js"><link rel="prefetch" href="/assets/js/46.fcf8af4b.js"><link rel="prefetch" href="/assets/js/47.2f2c8eb4.js"><link rel="prefetch" href="/assets/js/48.98013253.js"><link rel="prefetch" href="/assets/js/49.b43cc968.js"><link rel="prefetch" href="/assets/js/50.44ea2c12.js"><link rel="prefetch" href="/assets/js/51.e394ee79.js"><link rel="prefetch" href="/assets/js/52.0e87bfe5.js"><link rel="prefetch" href="/assets/js/53.d9d03a5b.js"><link rel="prefetch" href="/assets/js/54.86c9c033.js"><link rel="prefetch" href="/assets/js/55.837259d2.js"><link rel="prefetch" href="/assets/js/56.ef21a36e.js"><link rel="prefetch" href="/assets/js/57.082d62d8.js"><link rel="prefetch" href="/assets/js/58.b325a7b0.js"><link rel="prefetch" href="/assets/js/59.18ac5911.js"><link rel="prefetch" href="/assets/js/6.06349203.js"><link rel="prefetch" href="/assets/js/60.de1793b7.js"><link rel="prefetch" href="/assets/js/61.03e6eacf.js"><link rel="prefetch" href="/assets/js/62.197332e8.js"><link rel="prefetch" href="/assets/js/63.c8a2b91f.js"><link rel="prefetch" href="/assets/js/64.48b2e98d.js"><link rel="prefetch" href="/assets/js/65.0502d02f.js"><link rel="prefetch" href="/assets/js/8.0b6e1df5.js"><link rel="prefetch" href="/assets/js/9.a9bab149.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7a3888f9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo-color.png" alt="软件架构探索：The Fenix Project" class="logo"> <span class="site-name can-hide">软件架构探索：The Fenix Project</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码" class="dropdown-title"><span class="title">代码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/fenix-bookstore-frontend" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/monolithic_arch_springboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：单体架构 SpringBoot
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_springcloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 SpringCloud
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_kubernetes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Kubernetes
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/serverless_arch_knative" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：无服务架构 Knative
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="http://bookstore.icyfenix.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  示例
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/board.html" class="nav-link">
  讨论区
</a></div> <a href="https://github.com/fenixsoft/awesome-fenix" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="代码" class="dropdown-title"><span class="title">代码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/fenix-bookstore-frontend" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端工程
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/monolithic_arch_springboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：单体架构 SpringBoot
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_springcloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 SpringCloud
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/microservice_arch_kubernetes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：微服务架构 Kubernetes
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/fenixsoft/serverless_arch_knative" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端：无服务架构 Knative
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="http://bookstore.icyfenix.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  示例
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/board.html" class="nav-link">
  讨论区
</a></div> <a href="https://github.com/fenixsoft/awesome-fenix" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/introduction/about-me.html" class="sidebar-link">√ 关于作者</a></li><li><a href="/introduction/about-the-fenix-project.html" class="sidebar-link">√ 什么是“The Fenix Project”？</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>迈向软件架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/deployment/development-env-setup/" class="sidebar-heading clickable"><span>√ 如何开始</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/deployment/deployment-env-setup/" class="sidebar-heading clickable router-link-active open"><span>√ 环境依赖</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/deployment/deployment-env-setup/setup-docker.html" class="sidebar-link">√ 部署Docker CE容器环境</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/deployment/deployment-env-setup/setup-kubernetes" class="sidebar-heading clickable router-link-active open"><span>√ 部署Kubernetes集群</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.html" class="active sidebar-link">√ 使用Kubeadm部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.html#注册apt软件源" class="sidebar-link">注册apt软件源</a></li><li class="sidebar-sub-header"><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.html#安装kubelet、kubectl、kubeadm" class="sidebar-link">安装kubelet、kubectl、kubeadm</a></li><li class="sidebar-sub-header"><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.html#初始化集群前的准备" class="sidebar-link">初始化集群前的准备</a></li><li class="sidebar-sub-header"><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.html#预拉取镜像" class="sidebar-link">预拉取镜像</a></li><li class="sidebar-sub-header"><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.html#初始化集群控制平面" class="sidebar-link">初始化集群控制平面</a></li><li class="sidebar-sub-header"><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.html#让非root用户可以使用kubernetes" class="sidebar-link">让非Root用户可以使用Kubernetes</a></li><li class="sidebar-sub-header"><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.html#安装cni插件" class="sidebar-link">安装CNI插件</a></li><li class="sidebar-sub-header"><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.html#移除master节点上的污点" class="sidebar-link">移除Master节点上的污点</a></li><li class="sidebar-sub-header"><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.html#启用kubectl命令自动补全功能" class="sidebar-link">启用kubectl命令自动补全功能</a></li><li class="sidebar-sub-header"><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.html#将其他node节点加入到kubernetes集群中" class="sidebar-link">将其他Node节点加入到Kubernetes集群中</a></li></ul></li><li><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-rancher.html" class="sidebar-link">√ 使用Rancher部署</a></li><li><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-minikube.html" class="sidebar-link">√ 使用Minikube部署</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/deployment/operation-env-setup" class="sidebar-heading clickable"><span>运维环境</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>架构的视角</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/architect-perspective/general-architecture" class="sidebar-heading clickable open"><span>架构的普适问题</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/general-architecture/api-style.html" class="sidebar-link">√ 服务设计风格</a></li><li><a href="/architect-perspective/general-architecture/system-security.html" class="sidebar-link">√ 安全架构</a></li><li><a href="/architect-perspective/general-architecture/transaction.html" class="sidebar-link">事务</a></li><li><a href="/architect-perspective/general-architecture/constraint.html" class="sidebar-link">可约束性</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>技巧与专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/architect-perspective/tricks/distributed-transaction.html" class="sidebar-link">分布式与一致性</a></li><li><a href="/architect-perspective/tricks/graalvm-improvement.html" class="sidebar-link">GraalVM：微服务时代的Java</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>演进中的微服务</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/architect-history.html" class="sidebar-link">服务架构演进史</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architecture/monolithic-architecture" class="sidebar-heading clickable"><span>单体架构</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/monolithic-architecture/j2ee-base-arch.html" class="sidebar-link">基于J2EE的单体架构</a></li><li><a href="/architecture/monolithic-architecture/springboot-base-arch.html" class="sidebar-link">基于SpringBoot的单体架构</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architecture/microservices-architecture" class="sidebar-heading clickable"><span>微服务架构</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/microservices-architecture/springcloud-base-arch.html" class="sidebar-link">SpringCloud时代的微服务</a></li><li><a href="/architecture/microservices-architecture/kubernetes-base-arch.html" class="sidebar-link">Kubernetes时代的微服务</a></li><li><a href="/architecture/microservices-architecture/servicemesh-lstio-arch.html" class="sidebar-link">后Kubernetes时代的微服务</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/architecture/serverless-architecture" class="sidebar-heading clickable"><span>无服务架构</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/serverless-architecture/serverless-arch-knative.html" class="sidebar-link">基于Knative的无服务</a></li><li><a href="/architecture/serverless-architecture/serverless-arch-kubeless.html" class="sidebar-link">基于Kubeless的无服务</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>核心技术支撑点</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/technology/service-discovery.html" class="sidebar-link">服务发现</a></li><li><a href="/technology/load-balancing.html" class="sidebar-link">负载均衡</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/technology/invokechain-manage" class="sidebar-heading clickable"><span>链路治理</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/technology/invokechain-manage/traffic-control.html" class="sidebar-link">流控</a></li><li><a href="/technology/invokechain-manage/service-downgrade.html" class="sidebar-link">降级</a></li><li><a href="/technology/invokechain-manage/exception-inject.html" class="sidebar-link">异常注入</a></li><li><a href="/technology/invokechain-manage/invokechain-trace.html" class="sidebar-link">链路跟踪</a></li></ul></section></li><li><a href="/technology/logging.html" class="sidebar-link">日志追踪</a></li><li><a href="/technology/configuration.html" class="sidebar-link">配置中心</a></li><li><a href="/technology/message-queue-bus.html" class="sidebar-link">队列与消息总线</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>不可变基础设施</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/immutable-infrastructure/network" class="sidebar-heading clickable open"><span>网络</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/immutable-infrastructure/network/kubernetes-cni.html" class="sidebar-link">K8S的CNI网络</a></li><li><a href="/immutable-infrastructure/network/kubernetes-lb.html" class="sidebar-link">K8S的负载均衡</a></li></ul></section></li><li><a href="/immutable-infrastructure/storage.html" class="sidebar-link">共享存储</a></li><li><a href="/immutable-infrastructure/gpu-support.html" class="sidebar-link">GPU虚拟化</a></li><li><a href="/immutable-infrastructure/hardware-schedule.html" class="sidebar-link">硬件资源调度</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/release" class="sidebar-heading clickable"><span>产品发布准备</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/release/build-script.html" class="sidebar-link">构建发布脚本</a></li><li><a href="/release/continuous-integration.html" class="sidebar-link">持续集成</a></li><li><a href="/release/gated-launch.html" class="sidebar-link">灰度发布</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="√-使用kubeadm部署">√ 使用Kubeadm部署</h1> <p>尽管使用Rancher或者KubeSphere这样更高层次的管理工具，可以更“傻瓜式”地部署和管理Kubernetes集群，但kubeadm作为官方提供的用于快速安装Kbuernetes的命令行工具，仍然是应该掌握的基础技能。kubeadm随着新版的Kubernetes同步更新，时效性也会比其他更高层次的管理工具来的更好。</p> <p>随着Kubernetes不断成熟，kuberadm无论是部署单控制平面（Single Control-Plane，单Master节点）集群还是高可用（High-Availability，多Master节点）集群，都已经有了更优秀的易用性，现在手工部署Kubernetes集群已经不是什么太复杂、困难的事情了。本文以Debian系的Linux为例，介绍通过kuberadm部署集群的全过程。</p> <div class="custom-block tip"><p class="custom-block-title">注意事项</p> <ol><li>安装Kubernetes集群，需要从谷歌的仓库中拉取镜像，由于国内访问谷歌的网络受阻，需要通过科学上网或者在Docker中预先拉取好所需镜像等方式解决。</li> <li>集群中每台机器的Hostname不要重复，否则Kubernetes从不同机器收集状态信息时会产生干扰，被认为是同一台机器。</li> <li>安装Kubernetes最小需要2核CPU、2GB内存，且为x86架构（暂不支持ARM架构）。对于物理机来说，今时今日要找一台不满足以上条件的机器很困难，但对于云主机来说，尤其是购买网站上最低配置的同学，要注意一下是否达到了最低要求，不清楚的话请在/proc/cpuinf、/proc/meminfo中确认一下。</li> <li>确保网络通畅的——这听起来像是废话，但确实有相当一部分的云主机默认不对selinux、iptable、安全组、防火墙进行设置的话，内网各个节点之间、与外网之间会存在访问障碍，导致部署失败。</li></ol></div> <h2 id="注册apt软件源">注册apt软件源</h2> <p>由于Kubernetes并不在主流Debian系统自带的软件源中，所以要手工注册，然后才能使用apt-get安装。</p> <p>官方的GPG Key地址为：<a href="https://packages.cloud.google.com/apt/doc/apt-key.gpg" target="_blank" rel="noopener noreferrer">https://packages.cloud.google.com/apt/doc/apt-key.gpg<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，其中包括的软件源的地址为：<a href="https://apt.kubernetes.io/" target="_blank" rel="noopener noreferrer">https://apt.kubernetes.io/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（该地址最终又会被重定向至：<a href="https://packages.cloud.google.com/apt/" target="_blank" rel="noopener noreferrer">https://packages.cloud.google.com/apt/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。如果能访问google.com域名的机器，采用以下方法注册apt软件源是最佳的方式：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 添加GPG Key</span>
$ <span class="token function">sudo</span> <span class="token function">curl</span> -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -

<span class="token comment"># 添加K8S软件源</span>
$ <span class="token function">sudo</span> add-apt-repository <span class="token string">&quot;deb https://apt.kubernetes.io/ kubernetes-xenial main&quot;</span>
</code></pre></div><p>对于不能访问google.com的机器，就要借助国内的镜像源来安装了。虽然在这些镜像源中我已遇到过不止一次同步不及时的问题了——就是官方源中已经发布了软件的更新版本，而镜像源中还是旧版的，除了时效性问题外，还出现过其他的一些一致性问题，但是总归比没有的强。国内常见用的apt源有阿里云的、中科大的等，具体为：</p> <blockquote><p>阿里云：</p> <ul><li>GPG Key：<a href="http://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg" target="_blank" rel="noopener noreferrer">http://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>软件源：<a href="http://mirrors.aliyun.com/kubernetes/apt" target="_blank" rel="noopener noreferrer">http://mirrors.aliyun.com/kubernetes/apt<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>中科大：</p> <ul><li>GPG Key：<a href="https://raw.githubusercontent.com/EagleChen/kubernetes_init/master/kube_apt_key.gpg" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/EagleChen/kubernetes_init/master/kube_apt_key.gpg<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>软件源：<a href="http://mirrors.ustc.edu.cn/kubernetes/apt" target="_blank" rel="noopener noreferrer">http://mirrors.ustc.edu.cn/kubernetes/apt<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></blockquote> <p>它们的使用方式与官方源注册过程是一样的，只需替换里面的GPG Key和软件源的URL地址即可，譬如阿里云：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 添加GPG Key</span>
$ <span class="token function">curl</span> -fsSL http://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -

<span class="token comment"># 添加K8S软件源</span>
$ <span class="token function">sudo</span> add-apt-repository <span class="token string">&quot;deb http://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main&quot;</span>
</code></pre></div><p>添加源后记得执行一次更新：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update
</code></pre></div><h2 id="安装kubelet、kubectl、kubeadm">安装kubelet、kubectl、kubeadm</h2> <p>其实并不需要在每个节点都装上kubectl，但是，我缺的是哪点磁盘空间？</p> <p>下面简要列出了这三个工具/组件的作用，现在看不看得懂都没有关系，以后用到它们的机会多得是，要相信日久总会生情的。</p> <ul><li>kubeadm: 引导启动Kubernate集群的命令行工具。</li> <li>kubelet: 在群集中的所有计算机上运行的组件, 并用来执行如启动pods和containers等操作。</li> <li>kubectl: 用于操作运行中的集群的命令行工具。</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y kubelet kubeadm kubectl
</code></pre></div><h2 id="初始化集群前的准备">初始化集群前的准备</h2> <p>在使用kubeadm初始化集群之前，还有一些必须的前置工作要妥善处理：</p> <p>首先，基于安全性（如在文档中承诺的Secret只会在内存中读写）、利于保证节点同步一致性等原因，从1.8版开始，Kubernetes就在它的文档中明确声明了它<strong>默认不支持Swap分区</strong>，在未关闭Swap分区时，集群将直接无法启动。关闭Swap的命令为：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> swapoff -a
</code></pre></div><p>上面这个命令是一次性的，只在当前这次启动中生效，要彻底关闭Swap分区，需要在文件系统分区表的配置文件中去直接除掉Swap分区。使用vim打开/etc/fstab，注释其中带有swap的行即可，或使用以下命令直接完成修改：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 还是先备份一下</span>
$ <span class="token function">yes</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">cp</span> /etc/fstab /etc/fstab_bak

<span class="token comment"># 进行修改</span>
$ <span class="token function">sudo</span> <span class="token function">cat</span> /etc/fstab_bak <span class="token operator">|</span> <span class="token function">grep</span> -v swap <span class="token operator">&gt;</span> /etc/fstab
</code></pre></div><blockquote><p><strong>可选操作</strong></p> <p>当然，在服务器上使用的话，关闭Swap影响还是很大的，如果服务器除了Kubernetes还有其他用途的话（除非实在太穷，否则建议不要这样混用；一定要混用的话，宁可把其他服务搬到Kubernetes上）。关闭Swap有可能会对其他服务产生不良的影响，这时需要修改每个节点的kubelet配置，去掉必须关闭Swap的默认限制，具体操作为：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> <span class="token string">&quot;KUBELET_EXTRA_ARGS=--fail-swap-on=false&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/sysconfig/kubelet
</code></pre></div></blockquote> <p>其次，由于Kubernetes与Docker默认的cgroup（root控制组）驱动程序并不一致，Kubernetes默认为systemd，而Docker默认为cgroupfs。</p> <blockquote><p><strong>额外知识</strong></p> <p>Kubernetes是在Docker之上做容器编排的，为什么它的cgroup驱动会被设计成与Docker的不一致？</p> <p>尽管可能绝大多数的Kubernetes都是使用Docker作为容器配合使用的，但这两者并没有什么绝对绑定的依赖关系，Kubenetes对其管理的容器发布了一套名为”容器运行时接口“（Container Runtime Interface，CRI）的API，这套API在设计上，刻意兼容了”容器开放联盟“（Open Container Initiative，OCI）所制定的容器运行时标准，其他符合OCI标准的容器，同样也是可以与Kubernetes配合工作的，常见的有以下四种：</p> <ul><li><a href="https://github.com/kubernetes-incubator/cri-o" target="_blank" rel="noopener noreferrer">CRI-O <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：由Kubernetes自己发布的ORI参考实现</li> <li><a href="https://github.com/kubernetes-incubator/rktlet" target="_blank" rel="noopener noreferrer">rktlet <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：rkt容器运行时</li> <li><a href="https://github.com/kubernetes/frakti" target="_blank" rel="noopener noreferrer">Frakti <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：一种基于Hypervisor的容器运行时</li> <li><a href="https://github.com/kubernetes/kubernetes/tree/release-1.5/pkg/kubelet/dockershim" target="_blank" rel="noopener noreferrer">Docker CRI shim <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：支持Docker直接充当CRI适配器</li></ul></blockquote> <p>在这里我们要修改Docker或者Kubernetes其中一个的cgroup驱动，以便两者统一。根据官方文档《<a href="https://kubernetes.io/docs/setup/cri/" target="_blank" rel="noopener noreferrer">CRI installation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>》中的建议，对于使用systemd作为引导系统的Linux的发行版，使用systemd作为Docker的cgroup驱动程序可以服务器节点在资源紧张的情况表现得更为稳定。</p> <blockquote><p><strong>额外知识</strong></p> <p>cgroups是Linux内核提供的一种可以限制单个进程或者多个进程所使用资源的机制，可以对cpu，内存等资源实现精细化的控制。</p></blockquote> <p>这里选择修改各个节点上Docker的cgroup驱动为systemd，具体操作为编辑（无则新增）/etc/docker/daemon.json文件，加入以下内容即可：</p> <div class="language-text extra-class"><pre class="language-text"><code>{
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]
}
</code></pre></div><p>然后重新启动Docker容器：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ systemctl restart docker
</code></pre></div><h2 id="预拉取镜像">预拉取镜像 <span class="badge warning" style="vertical-align:top;" data-v-15b7b770>可选</span></h2> <p>预拉取镜像并不是必须的，本来初始化集群的时候系统就会自动拉取Kubernetes中要使用到的Docker镜像组件，也提供了一个“kubeadm config images pull”命令来一次性的完成拉取，这都是因为如果要手工来进行这项工作，实在非常非常非常的繁琐。</p> <p>但对于许多人来说这项工作往往又是无可奈何的，Kubernetes的镜像都存储在k8s.gcr.io上，如果您的机器无法直接或通过代理访问到gcr.io（Google Container Registry，敲黑板：这是属于谷歌的网址）的话，初始化集群时自动拉取就无法顺利进行，所以就不得不手工预拉取。</p> <p>预拉取的意思是，由于Docker只要查询到本地有相同（名称和tag完全相同、哈希相同）的镜像，就不会访问远程仓库，那只要从GitHub上拉取到所需的镜像，再将tag修改成官方的一致，就可以跳过网络访问阶段。</p> <p>首先使用以下命令查询当前版本需要哪些镜像：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubeadm config images list --kubernetes-version v1.17.3

k8s.gcr.io/kube-apiserver:v1.17.3
k8s.gcr.io/kube-controller-manager:v1.17.3
k8s.gcr.io/kube-scheduler:v1.17.3
k8s.gcr.io/kube-proxy:v1.17.3
k8s.gcr.io/pause:3.1
k8s.gcr.io/etcd:3.4.3-0
k8s.gcr.io/coredns:1.6.5
……
</code></pre></div><p>这里必须使用“--kubernetes-version”参数指定具体版本，因为尽管每个版本需要的镜像信息在本地是有存储的，但如果不加的话，Kubernetes会向远程查询最新的版本号，又会因网络无法访问而导致问题。</p> <p>得到这些镜像名称和tag后，可以从<a href="https://hub.docker.com" target="_blank" rel="noopener noreferrer">DockerHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上找存有相同镜像的仓库来拉取，至于具体哪些公开仓库有，考虑到以后阅读本文时Kubernetes的版本应该会有所差别，所以需要自行到网站上查询一下。笔者比较常用的是一个名为“anjia0532”的仓库，有机器人自动跟官方同步，相对比较及时。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#以k8s.gcr.io/coredns:1.6.5为例，每个镜像都要这样处理一次</span>
$ docker pull anjia0532/google-containers.coredns:1.6.5

<span class="token comment">#修改tag</span>
$ docker tag anjia0532/google-containers.coredns:1.6.5 k8s.gcr.io/coredns:1.6.5

<span class="token comment">#修改完tag后就可以删除掉旧镜像了</span>
$ docker rmi anjia0532/google-containers.coredns:1.6.5
</code></pre></div><h2 id="初始化集群控制平面">初始化集群控制平面</h2> <p>到了这里，终于可以开始Master节点的部署了，先通过su直接切换到root用户（而不是使用sudo），然后使用以下命令开始部署：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubeadm init --kubernetes-version v1.17.3 --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16
</code></pre></div><p>这里使用“--kubernetes-version”参数的原因与前面预拉取是一样的，避免额外的网络访问；另外一个参数“--pod-network-cidr”着在稍后介绍完CNI网络插件时会去说明。</p> <p>当看到下面信息之后，说明集群主节点已经安装完毕了。</p> <p><img src="/assets/img/kubernetes-initialized.7c7ddc17.png" alt=""></p> <p>这信息先恭喜你已经把控制平面安装成功了，但还有三行“you need……”、“you should……”、“you can……”开头的内容，这是三项后续的“可选”工作，下面继续介绍。</p> <h2 id="让非root用户可以使用kubernetes">让非Root用户可以使用Kubernetes <span class="badge warning" style="vertical-align:top;" data-v-15b7b770>可选</span></h2> <p>Kubernetes最初是以root用户安装的，如果需要非root的其他用户也可以使用Kubernetes集群，那需要为该用户先配置好admin.conf文件。切换至该用户后，进行如下操作：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
$ <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
$ <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
</code></pre></div><p>当然，如果只是在测试环境，准备后续都准备使用root运行，那这个步骤可以略过。</p> <h2 id="安装cni插件">安装CNI插件 <span class="badge warning" style="vertical-align:top;" data-v-15b7b770>可选</span></h2> <p>CNI即“容器网络接口”，在2016 年，CoreOS发布了CNI规范。2017年5月，CNI被CNCF技术监督委员会投票决定接受为托管项目，从此成为不同容器编排工具（Kubernetes、Mesos、OpenShift）可以共同使用的、解决容器之间网络通讯的统一接口规范。</p> <p>部署Kubernetes时，我们可以有两种网络方案使得以后受管理的容器之间进行网络通讯：</p> <ul><li>使用Kubernetes的默认网络</li> <li>使用CNI及其插件</li></ul> <p>第一种方案，尤其不在GCP或者AWS的云主机上，没有它们的命令行管理工具时，需要大量的手工配置，基本上是反人类的。实际通常都会采用第二种方案，使用CNI插件来处理容器之间的网络通讯，所以本节所标识的“[可选]”其实也并没什么选择不安装CNI插件的余地。</p> <p>Kubernetes目前支持的CNI插件有：Calico、Cilium、Contiv-VPP、Flannel、Kube-router、Weave Net等六种，每种网络提供了不同的管理特性（如MTU自动检测）、安全特性（如是否支持加密通讯）、网络策略（如Ingress、Egress规则）、传输性能（甚至对TCP、UDP、HTTP、FTP、SCP等不同协议来说也有不同的性能表现）以及主机的性能消耗。后续我们将专门对不同CNI插件进行测试对比，在环境部署这部分，对于初学者来说，使用Flannel是较为合适的，它是最精简的CNI，没有安全特性的支持，主机压力小，安装便捷，效率也不错，使用以下命令安装Flannel网络：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> --insecure -sfL https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml <span class="token operator">|</span> kubectl apply -f -
</code></pre></div><p>使用Flannel的话，要注意要在创建集群时加入“--pod-network-cidr”参数，指明网段划分。</p> <h2 id="移除master节点上的污点">移除Master节点上的污点 <span class="badge warning" style="vertical-align:top;" data-v-15b7b770>可选</span></h2> <p>污点（Taint）是Kubernetes Pod调度中的概念，在这里通俗地理解就是Kubernetes决定在集群中的哪一个节点建立新的容器时，要先排除掉带有特定污点的节点，以避免容器在Kubernetes不希望运行的节点中创建、运行。默认情况下，集群的Master节点是会带有污点的，以避免容器分配到Master中创建。但对于许多学习Kubernetes的同学来说，并没有多宽裕的机器数量，往往是建立单节点集群或者最多只有两、三个节点，这样Master节点不能运行容器就显得十分浪费了。需要移除掉Master节点上所有的污点，在Master节点上执行以下命令即可：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl taint nodes --all node-role.kubernetes.io/master-
</code></pre></div><p>做到这步，如果你只有一台机器的话，那Kubernetes的安装已经宣告结束了，可以使用此环境来完成后续所有的部署。你还可以通过cluster-info和get nodes子命令来查看一下集群的状态，类似如下所示：</p> <p><img src="/assets/img/kubernetes-setup-completed.08416ad7.png" alt=""></p> <h2 id="启用kubectl命令自动补全功能">启用kubectl命令自动补全功能 <span class="badge warning" style="vertical-align:top;" data-v-15b7b770>可选</span></h2> <p>由于kubectl命令在后面十分常用，而且Kubernetes许多资源名称都带有随机字符，要手工照着敲很容易出错，强烈推荐启用命令自动补全的功能，这里仅以bash和笔者常用的zsh为例，如果您使用其他shell，需自行调整：</p> <blockquote><p>bash：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> <span class="token string">'source &lt;(kubectl completion bash)'</span> <span class="token operator">&gt;&gt;</span> ~/.bashrc
$ <span class="token builtin class-name">echo</span> <span class="token string">'source /usr/share/bash-completion/bash_completion'</span> <span class="token operator">&gt;&gt;</span> ~/.bashrc
</code></pre></div><p>zsh：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> <span class="token string">'source &lt;(kubectl completion zsh)'</span> <span class="token operator">&gt;&gt;</span> <span class="token operator">!</span>/.zshrc
</code></pre></div></blockquote> <h2 id="将其他node节点加入到kubernetes集群中">将其他Node节点加入到Kubernetes集群中</h2> <p>在安装Master节点时候，输出的最后一部分内容会类似如下所示：</p> <div class="language-text extra-class"><pre class="language-text"><code>Then you can join any number of worker nodes by running the following on each as root:

  kubeadm join 10.3.7.5:6443 --token ejg4tt.y08moym055dn9i32 \
    --discovery-token-ca-cert-hash sha256:9d2079d2844fa2953d33cc0da57ab15f571e974aa40ccb50edde12c5e906d513
</code></pre></div><p>这部分内容是告诉用户，集群的Master节点已经建立完毕，其他节点的机器可以使用“kubeadm join”命令加入集群。这些机器只要完成kubeadm、kubelet、kubectl的安装即可、其他的所有步骤，如拉取镜像、初始化集群等等都不需要去做，就是可以使用该命令加入集群了。需要注意的是，该Token的有效时间为24小时，如果超时，使用以下命令重新获取：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubeadm token create --print-join-command
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/fenixsoft/awesome-fenix/edit/master/deployment/deployment-env-setup/setup-kubernetes/setup-kubeadm.md" target="_blank" rel="noopener noreferrer">在GitHub中编辑</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">3/26/2020, 11:41:40 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/deployment/deployment-env-setup/setup-docker.html" class="prev">
        √ 部署Docker CE容器环境
      </a></span> <span class="next"><a href="/deployment/deployment-env-setup/setup-kubernetes/setup-rancher.html">
        √ 使用Rancher部署
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bf25c76c.js" defer></script><script src="/assets/js/2.d5b46b4e.js" defer></script><script src="/assets/js/7.681e02a5.js" defer></script><script src="/assets/js/5.797f2502.js" defer></script>
  </body>
</html>
